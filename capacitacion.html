<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Capacitaci√≥n SST</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#f4f6f9; }
    header { background:#0078d7; color:white; padding:12px 20px; display:flex; justify-content:space-between; align-items:center; }
    main { padding:20px; display:grid; grid-template-columns:repeat(auto-fit,minmax(350px,1fr)); gap:20px; }
    .modulo { background:white; border-radius:10px; box-shadow:0 3px 8px rgba(0,0,0,0.1); overflow:hidden; }
    .modulo h3 { margin:0; padding:10px; background:#e9ecef; }
    iframe { border:none; width:100%; }
    .videoFrame { height:240px; }
    .formFrame { height:400px; display:none; border-top:1px solid #eee; }
    .info { padding:10px; font-size:14px; background:#fafafa; border-top:1px solid #eee; }
    .notificacion { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#0078d4; color:white; padding:10px 20px; border-radius:6px; display:none; box-shadow:0 3px 6px rgba(0,0,0,0.3); }
  </style>
</head>
<body>
  <header>
    <h2>Plataforma de Capacitaci√≥n SST</h2>
    <button onclick="logout()">Cerrar sesi√≥n</button>
  </header>

  <main id="contenedorModulos"></main>
  <div id="notificacion" class="notificacion"></div>

  <script>
    const URL_HOJA1 = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTmakWaQb439YnevNTOssg1bPzA2Oz5CtZeHok3UXmaciQkD2Ed-nTweo8sFi3pIHwgzZrM610NoBME/pub?gid=0&single=true&output=csv";
    const URL_HOJA2 = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTmakWaQb439YnevNTOssg1bPzA2Oz5CtZeHok3UXmaciQkD2Ed-nTweo8sFi3pIHwgzZrM610NoBME/pub?gid=1479015803&single=true&output=csv";

    const user = JSON.parse(sessionStorage.getItem("user")) || { dni: "12345678" };

    function transformarVideo(link){return link?.includes("/view")?link.replace("/view","/preview"):link;}
    function transformarForm(link){return link?(link.includes("?")?link+"&embedded=true":link+"?embedded=true"):"";}

    async function obtenerCSV(url){
      const r=await fetch(url); const t=await r.text();
      return t.trim().split("\n").map(l=>l.split(","));
    }

    function calcularVencimiento(fechaStr){
      if(!fechaStr) return null;
      const [d,m,a]=fechaStr.split("/");
      const f=new Date(`${a}-${m}-${d}`);
      f.setFullYear(f.getFullYear()+1); // vence 1 a√±o despu√©s
      return f;
    }

    async function cargarModulos(){
      const hoja1 = await obtenerCSV(URL_HOJA1);
      const hoja2 = await obtenerCSV(URL_HOJA2);

      const header1 = hoja1[0];
      const filaUsuario = hoja1.find(f => f[header1.indexOf("DNI/CE")]?.trim() === user.dni.trim());
      const h2 = hoja2[0], f2 = hoja2[1];

      const links = {
        induccion: { video:f2[h2.indexOf("LINK VIDEO DE INDUCCION SST")], form:f2[h2.indexOf("LINK EVALUACION INDUCCION")] },
        primerosAuxilios: { video:f2[h2.indexOf("LINK VIDEO DE PRIMEROS AUXILIOS")], form:f2[h2.indexOf("LINK EVALUACION PRIMEROS AUXILIOS")] },
        ergonomia: { video:f2[h2.indexOf("LINK VIDEO DE ERGONOMIA EN EL TRABAJO")], form:f2[h2.indexOf("LINK EVALUACION ERGONOMIA")] },
        epp: { video:f2[h2.indexOf("LINK VIDEO DE EPP")], form:f2[h2.indexOf("LINK EVALUACION EPP")] }
      };

      const modulos = [
        { key:"induccion", nombre:"Inducci√≥n SST" },
        { key:"primerosAuxilios", nombre:"Primeros Auxilios" },
        { key:"ergonomia", nombre:"Ergonom√≠a en el Trabajo" },
        { key:"epp", nombre:"EPP" }
      ];

      const cont = document.getElementById("contenedorModulos");
      cont.innerHTML="";

      modulos.forEach(m=>{
        const colVideo = header1.indexOf(`VIDEO DE ${m.nombre.toUpperCase()}`);
        const colNota = header1.indexOf("NOTA");
        const colFecha = header1.indexOf("FECHA DE INICIO");

        const fechaInicio = filaUsuario?.[colFecha] || "";
        const nota = parseFloat(filaUsuario?.[colNota]) || 0;
        const vence = calcularVencimiento(fechaInicio);
        const hoy = new Date();
        const vencido = vence && hoy > vence;

        let estadoTxt = "";
        let mostrarForm = false;

        if (!nota || nota < 13 || vencido){
          estadoTxt = vencido ? `‚ö†Ô∏è Capacitaci√≥n vencida el ${vence.toLocaleDateString()}` : "üïì Pendiente de aprobaci√≥n";
          mostrarForm = true;
        } else {
          estadoTxt = `‚úÖ Aprobado (${nota}) - Vence el ${vence.toLocaleDateString()}`;
        }

        const html = `
        <div class="modulo">
          <h3>${m.nombre}</h3>
          <iframe class="videoFrame" src="${transformarVideo(links[m.key].video)}"></iframe>
          <div class="info">${estadoTxt}</div>
          ${mostrarForm ? `<iframe class="formFrame" style="display:block;" src="${transformarForm(links[m.key].form)}"></iframe>` : ""}
        </div>`;
        cont.insertAdjacentHTML("beforeend", html);
      });
    }

    function logout(){sessionStorage.clear();window.location.href="index.html";}

    cargarModulos();
  </script>
</body>
</html>
