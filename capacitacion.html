function doGet(e) {
  try {
    const ss = SpreadsheetApp.openById("1aqXKp2XFTcDWw0VK72G_FkVp4MC9bjLqGnjhs14Ef6Y");
    const hoja = ss.getSheets()[0];
    const params = e.parameter;
    const dni = params.dni || "";
    const modulo = params.modulo || "";

    if (!dni || !modulo) return ContentService.createTextOutput(JSON.stringify({ ok:false, mensaje:"Faltan parÃ¡metros" })).setMimeType(ContentService.MimeType.JSON);

    const data = hoja.getDataRange().getValues();
    const header = data[0];
    const colDni = header.indexOf("DNI/CE");
    if (colDni === -1) return ContentService.createTextOutput(JSON.stringify({ ok:false, mensaje:"No hay columna DNI/CE" })).setMimeType(ContentService.MimeType.JSON);

    const fila = data.findIndex((r,i) => i>0 && String(r[colDni]).trim() === dni.trim());
    if (fila === -1) return ContentService.createTextOutput(JSON.stringify({ ok:false, mensaje:"Usuario no encontrado" })).setMimeType(ContentService.MimeType.JSON);

    const modulos = {
      induccion: "VIDEO DE INDUCCION SST",
      primerosAuxilios: "VIDEO DE PRIMEROS AUXILIOS",
      ergonomia: "VIDEO DE ERGONOMIA EN EL TRABAJO",
      epp: "VIDEO DE EPP"
    };

    const colBase = header.indexOf(modulos[modulo]);
    const fechaActual = Utilities.formatDate(new Date(), "GMT-5", "dd/MM/yyyy HH:mm");
    hoja.getRange(fila + 1, colBase + 1).setValue(fechaActual);

    return ContentService.createTextOutput(JSON.stringify({ ok:true, mensaje: fechaActual })).setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({ ok:false, mensaje: err.message })).setMimeType(ContentService.MimeType.JSON);
  }
}
