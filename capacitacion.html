<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Capacitación SST</title>
  <style>
    body { margin:0; font-family:Arial, sans-serif; background:#f5f7fa; }
    header { background:#0078d4; color:white; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; }
    main { padding:20px; display:grid; grid-template-columns:repeat(auto-fit,minmax(350px,1fr)); gap:20px; }
    .modulo { background:white; border-radius:10px; box-shadow:0 3px 8px rgba(0,0,0,0.1); overflow:hidden; }
    .modulo h3 { margin:0; padding:10px; background:#e8eef5; text-align:center; }
    iframe { border:none; width:100%; }
    .videoFrame { height:240px; }
    .formFrame { height:400px; display:none; }
    .info { padding:10px; background:#fafafa; border-top:1px solid #eee; text-align:center; font-size:14px; }
    .btn { margin:10px auto; padding:8px 16px; background:#0078d4; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold; display:block; }
    .btn:hover { background:#005fa3; }
    #invisibleFrame { display:none; }
  </style>
</head>
<body>
  <header>
    <h2>Plataforma de Capacitación SST</h2>
    <button class="btn" onclick="logout()">Cerrar sesión</button>
  </header>

  <main id="contenedorModulos"></main>

  <iframe id="invisibleFrame" name="invisibleFrame"></iframe>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbysoulPDCJvo2kTkpTPHKf0-8m6EbO4MM52MlE3T1nGzwum3XFtiNKeDzcV4bqRwovqCQ/exec";
    const URL_HOJA1 = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTmakWaQb439YnevNTOssg1bPzA2Oz5CtZeHok3UXmaciQkD2Ed-nTweo8sFi3pIHwgzZrM610NoBME/pub?gid=0&single=true&output=csv";
    const URL_HOJA2 = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTmakWaQb439YnevNTOssg1bPzA2Oz5CtZeHok3UXmaciQkD2Ed-nTweo8sFi3pIHwgzZrM610NoBME/pub?gid=1479015803&single=true&output=csv";

    const user = JSON.parse(sessionStorage.getItem("user"));
    if (!user) window.location.href = "index.html";

    const modulos = [
      { key: "induccion", nombre: "Video de Inducción SST" },
      { key: "primerosAuxilios", nombre: "Video de Primeros Auxilios" },
      { key: "ergonomia", nombre: "Video de Ergonomía en el Trabajo" },
      { key: "epp", nombre: "Video de EPP" }
    ];

    const transformarVideo = l => l?.replace("/view", "/preview") || "";
    const transformarForm = l => l ? (l.includes("?") ? l + "&embedded=true" : l + "?embedded=true") : "";

    async function obtenerCSV(url) {
      const r = await fetch(url);
      const t = await r.text();
      return t.trim().split("\n").map(x => x.split(","));
    }

    async function obtenerDatos() {
      const [h1, h2] = await Promise.all([obtenerCSV(URL_HOJA1), obtenerCSV(URL_HOJA2)]);
      const head1 = h1[0], head2 = h2[0];
      const data1 = h1.slice(1), data2 = h2.slice(1);
      const usuario = data1.find(r => r[head1.indexOf("DNI/CE")].trim() === user.dni);

      const links = {
        induccion: { video: data2[0][head2.indexOf("LINK VIDEO DE INDUCCION SST")], form: data2[0][head2.indexOf("LINK EVALUACION")] },
        primerosAuxilios: { video: data2[0][head2.indexOf("LINK VIDEO DE PRIMEROS AUXILIOS")], form: data2[0][head2.lastIndexOf("LINK EVALUACION")] },
        ergonomia: { video: data2[0][head2.indexOf("LINK VIDEO DE ERGONOMIA EN EL TRABAJO")], form: data2[0][head2.lastIndexOf("LINK EVALUACION")] },
        epp: { video: data2[0][head2.indexOf("LINK VIDEO DE EPP")], form: data2[0][head2.lastIndexOf("LINK EVALUACION")] }
      };

      return { head1, usuario, links };
    }

    function crearModulo(nombre, key, video, form, nota, inicio) {
      const v = transformarVideo(video);
      const f = transformarForm(form);
      return `
        <div class="modulo" id="mod-${key}">
          <h3>${nombre}</h3>
          <iframe class="videoFrame" src="${v}"></iframe>
          <form method="GET" action="${API_URL}" target="invisibleFrame" onsubmit="enviarConfirmacion('${key}', this); return false;">
            <input type="hidden" name="action" value="registrar">
            <input type="hidden" name="dni" value="${user.dni}">
            <input type="hidden" name="modulo" value="${key}">
            <button class="btn" type="submit">Confirmar que vi el video</button>
          </form>
          <div class="info" id="estado-${key}">${inicio ? '✅ Registrado: ' + inicio : '⏳ Aún sin confirmar'}</div>
          <iframe class="formFrame" id="form-${key}" src="${f}"></iframe>
        </div>`;
    }

    async function cargarModulos() {
      const { head1, usuario, links } = await obtenerDatos();
      if (!usuario) return alert("Usuario no encontrado");
      const cont = document.getElementById("contenedorModulos");
      cont.innerHTML = "";
      const columnas = {
        induccion: "VIDEO DE INDUCCION SST",
        primerosAuxilios: "VIDEO DE PRIMEROS AUXILIOS",
        ergonomia: "VIDEO DE ERGONOMIA EN EL TRABAJO",
        epp: "VIDEO DE EPP"
      };
      modulos.forEach(m => {
        const base = head1.indexOf(columnas[m.key]);
        const nota = usuario[base + 1];
        const inicio = usuario[base + 2];
        cont.insertAdjacentHTML("beforeend", crearModulo(m.nombre, m.key, links[m.key].video, links[m.key].form, nota, inicio));
      });
    }

    function enviarConfirmacion(modulo, form) {
      const estado = document.getElementById(`estado-${modulo}`);
      const formEval = document.getElementById(`form-${modulo}`);
      const boton = form.querySelector("button");

      boton.disabled = true;
      boton.textContent = "Enviando...";
      form.submit();

      setTimeout(() => {
        form.style.display = "none";
        estado.innerHTML = "✅ Video confirmado correctamente";
        formEval.style.display = "block";
      }, 2000);
    }

    function logout() {
      sessionStorage.clear();
      window.location.href = "index.html";
    }

    cargarModulos();
  </script>
</body>
</html>
