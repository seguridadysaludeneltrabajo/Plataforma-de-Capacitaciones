<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Capacitaci√≥n SSt ‚Äî Temporizador y Bloqueo + Nota ‚â• 12</title>
  <style>
    :root{--logo-url:none}
    body{margin:0;font-family:"Segoe UI",Arial,sans-serif;background:linear-gradient(135deg,rgba(0,120,215,0.18),rgba(0,200,255,0.12));min-height:100vh;position:relative;overflow-x:hidden}
    header{background:rgba(0,120,215,0.9);color:#fff;padding:10px 20px;display:flex;justify-content:space-between;align-items:center;z-index:2}
    .header-left{display:flex;gap:10px;align-items:center}
    .header-left img{height:45px;border-radius:8px;background:#fff;padding:3px}
    main{padding:30px 5vw;display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:25px;z-index:2;justify-items:center}
    .modulo{background:rgba(255,255,255,0.95);border-radius:14px;box-shadow:0 4px 12px rgba(0,0,0,0.1);overflow:hidden;display:flex;flex-direction:column;width:100%;max-width:550px;position:relative;padding-bottom:12px}
    .modulo.bloqueado{opacity:.45;pointer-events:none;filter:grayscale(.02)}
    .modulo h3{margin:0;padding:14px 16px;background:#e9f1fb;color:#004a99;font-size:16px;font-weight:600;border-bottom:1px solid #d0e2fb}
    iframe.videoFrame{width:100%;aspect-ratio:16/9;border:0}
    iframe.formFrame{width:100%;height:420px;border:0;display:none}
    .info{padding:12px 18px;font-size:14px;background:#fafafa;border-top:1px solid #eee;line-height:1.5}
    .aprobado{color:#007a00;font-weight:700}
    .vencido{color:#d40000;font-weight:700}
    .contador{font-weight:700;margin-top:8px}
    .progress-bar{width:90%;height:10px;background:#eee;border-radius:6px;overflow:hidden;margin:10px auto}
    .progress-fill{height:100%;width:0%;background:#4caf50;transition:width 1s linear}
    .rotate-message{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,120,215,0.9);color:#fff;padding:10px 18px;border-radius:10px;font-size:14px;font-weight:500;opacity:0;pointer-events:none;transition:opacity .3s;z-index:5}
    .rotate-message.show{opacity:1}
    .refresh-btn{background:#0078d7;color:#fff;border:none;padding:8px 14px;border-radius:8px;margin:10px auto 0;display:block}
    @media(max-width:800px){main{grid-template-columns:1fr;padding:20px}}
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <img id="logo" alt="Logo" />
      <h2 id="bienvenida">Bienvenido(a):</h2>
    </div>
    <button onclick="logout()">Cerrar sesi√≥n</button>
  </header>

  <main id="contenedorModulos"></main>

  <script>
  /*************************************************************************
   * CONFIG
   *************************************************************************/
  const URL_HOJA1 = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTmakWaQb439YnevNTOssg1bPzA2Oz5CtZeHok3UXmaciQkD2Ed-nTweo8sFi3pIHwgzZrM610NoBME/pub?gid=0&single=true&output=csv";
  const URL_HOJA2 = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTmakWaQb439YnevNTOssg1bPzA2Oz5CtZeHok3UXmaciQkD2Ed-nTweo8sFi3pIHwgzZrM610NoBME/pub?gid=1479015803&single=true&output=csv";

  const NOTA_MINIMA = 12; // tu requisito: nota >= 12 aprueba
  const DURACIONES_SEG = [1010, 1075, 1139, 769, 1272]; // tiempos en segundos (orden de videos)

  // intentamos obtener DNI desde sessionStorage.user.dni; si no est√°, pedimos
  let user = JSON.parse(sessionStorage.getItem("user") || "{}");
  if (!user || !user.dni) {
    const dni = prompt("Ingrese su DNI/CE para continuar (se guardar√° en esta sesi√≥n):");
    user = user || {};
    user.dni = dni ? dni.trim() : "";
    sessionStorage.setItem("user", JSON.stringify(user));
  }

  /*************************************************************************
   * UTIL: parse CSV (tu funci√≥n)
   *************************************************************************/
  function parseCSV(text){
    const rows = [];
    let cur = "", row = [], inQuotes = false;
    for (let i=0;i<text.length;i++){
      const ch = text[i], next = text[i+1];
      if (ch === '"'){ if (inQuotes && next === '"'){ cur+='"'; i++; continue; } inQuotes=!inQuotes; continue; }
      if (!inQuotes && ch === ','){ row.push(cur); cur=""; continue; }
      if (!inQuotes && (ch === '\n' || ch === '\r')){ if(ch==='\r'&&text[i+1]==='\n')i++; row.push(cur); rows.push(row); row=[]; cur=""; continue; }
      cur+=ch;
    }
    if (cur!==""||row.length){ row.push(cur); rows.push(row); }
    return rows.map(r=>r.map(c=>(c||"").trim()));
  }
  async function obtenerCSV(url){
    const res = await fetch(url);
    const txt = await res.text();
    return parseCSV(txt);
  }

  function driveToPreview(url){
    if (!url) return "";
    const m = url.match(/(?:\/d\/|id=)([-\\w]{20,})/);
    if (m) return `https://drive.google.com/file/d/${m[1]}/preview`;
    return url;
  }

  function transformarVideo(link){
    if (!link) return "";
    return link.includes("/view") ? link.replace("/view", "/preview") : link;
  }
  function transformarForm(link){
    if (!link) return "";
    return link.includes("viewform") ? (link.includes("?") ? link + "&embedded=true" : link + "?embedded=true") : link;
  }

  /*************************************************************************
   * Aplicar logo y nombre
   *************************************************************************/
  async function aplicarLogo(){
    try {
      const hoja2 = await obtenerCSV(URL_HOJA2);
      const headers = hoja2[0].map(h => (h||"").trim().toUpperCase());
      const idxLogo = headers.indexOf("LINK LOGO");
      const fila = hoja2[1] || [];
      const logoLink = (idxLogo !== -1 ? fila[idxLogo] : fila[fila.length-1] || "").trim();
      if (logoLink){
        const img = document.getElementById("logo");
        img.src = driveToPreview(logoLink);
        document.documentElement.style.setProperty("--logo-url", `url('${logoLink}')`);
      }
      document.getElementById("bienvenida").textContent = `Bienvenido(a): ${user.nombre || user.dni || "Usuario"}`;
    } catch (e){
      console.warn("aplicarLogo:", e);
    }
  }

  /*************************************************************************
   * Cargar m√≥dulos (lee Hoja1 y Hoja2)
   *
   * Asume tu Hoja1 tiene encabezado (ej: NOMBRE COMPLETO, DNI/CE, CONTRASE√ëA, ...)
   * - Busca la fila del usuario por coincidencia exacta en la columna "DNI/CE" (columna B)
   *
   * Hoja2 contiene pares [video, form, video, form, ...] en la primera fila usada aqu√≠.
   *************************************************************************/
  async function cargarModulos(){
    const hoja1 = await obtenerCSV(URL_HOJA1);
    const hoja2 = await obtenerCSV(URL_HOJA2);

    // validar
    if (!hoja1 || hoja1.length === 0) {
      document.getElementById("contenedorModulos").innerHTML = "<p>Error leyendo Hoja1</p>";
      return;
    }
    const headers1 = hoja1[0].map(h => (h||"").trim().toUpperCase());
    // Buscar √≠ndice de columna "DNI/CE" (sensitivo al header enviado)
    const idxDniCol = headers1.findIndex(h => h.includes("DNI") || h.includes("DNI/CE") || h.includes("DNI/CE "));
    // Fila del usuario (coincide por columna B en tu sheet; pero usamos b√∫squeda por header robusta)
    const filaUsuario = hoja1.find(r => {
      // si idxDniCol v√°lido
      if (idxDniCol !== -1) return (r[idxDniCol] || "").trim() === (user.dni || "");
      // fallback: buscar en la segunda columna (√≠ndice 1)
      return (r[1] || "").trim() === (user.dni || "");
    });

    const filaLinks = (hoja2[1] || hoja2[0] || []); // preferimos fila 2 si existe, sino fila 1

    const cont = document.getElementById("contenedorModulos");
    cont.innerHTML = "";

    if (!filaUsuario){
      cont.innerHTML = "<p>No se encontr√≥ tu registro. Aseg√∫rate de usar el mismo DNI/CE.</p>";
      return;
    }

    // detectar todas las columnas "VIDEO ..." en header1 y mapear su posici√≥n
    const columnasVideo = headers1.map((h,i)=>({nombre:h,index:i})).filter(o=> o.nombre.includes("VIDEO"));

    // Por cada columna VIDEO generamos m√≥dulo. Notar que en tu estructura: VIDEO, NOTA, FECHA INICIO repetido.
    columnasVideo.forEach((col, modIndex) => {
      const vidColIndex = col.index;
      const notaColIndex = vidColIndex + 1; // en tu hoja la nota est√° inmediatamente despu√©s
      const fechaColIndex = vidColIndex + 2;
      const notaValor = parseFloat(filaUsuario[notaColIndex] || "0");
      const fechaInicio = filaUsuario[fechaColIndex] || "";
      const venc = calcularVencimiento(fechaInicio);
      const vencido = estaVencido(fechaInicio);

      // video/form links en hoja2 vienen en pares: i*2, i*2+1
      const videoSrc = transformarVideo(filaLinks[modIndex * 2] || "");
      const formSrc = transformarForm(filaLinks[modIndex * 2 + 1] || "");
      const titulo = col.nombre.replace(/VIDEO\s*(DE)?\s*/i,"").trim() || `M√≥dulo ${modIndex+1}`;

      const yaAprobado = (notaValor >= NOTA_MINIMA && !vencido);

      // duracion seg√∫n orden (si hay menos duraciones: fallback 60s)
      const durSeg = DURACIONES_SEG[modIndex] || 60;

      cont.insertAdjacentHTML("beforeend", `
        <div class="modulo" id="modulo_${modIndex}" data-idx="${modIndex}" data-duracion="${durSeg}">
          <h3>${titulo}</h3>

          <div style="position:relative;">
            <iframe class="videoFrame" src="${videoSrc}" allow="autoplay; fullscreen"></iframe>
            <div class="rotate-message">üì∫ Gira tu celular para ver mejor el video</div>
          </div>

          <div class="info" id="info_${modIndex}">
            ${fechaInicio?`<p>üìÖ Fecha de inicio: ${fechaInicio}</p>`:""}
            ${venc?`<p>üìÜ Fecha de vencimiento: ${venc}</p>`:""}
            ${yaAprobado ? `<p class="aprobado">‚úÖ Aprobado con nota ${notaValor}. Vence el ${venc || '‚Äî'}.</p>` : (vencido && fechaInicio ? `<p class="vencido">‚ö†Ô∏è Vencido el ${venc}. Debe volver a rendir la evaluaci√≥n.</p>` : `<p>üïì Pendiente de evaluaci√≥n.</p>`)}
            <div class="contador" id="contador_${modIndex}"></div>
            <div class="progress-bar"><div class="progress-fill" id="progreso_${modIndex}"></div></div>
          </div>

          <iframe class="formFrame" id="form_${modIndex}" src="${formSrc}" style="display:${yaAprobado ? "none" : "none"}"></iframe>

          ${!yaAprobado ? `<button class="refresh-btn" id="refresh_${modIndex}" onclick="refrescarModulo(this)">üîÑ Refrescar m√≥dulo</button>` : ""}
        </div>
      `);

      // si ya aprobado, marcar completado local (para desbloqueos)
      if (yaAprobado) {
        localStorage.setItem(`mod_ok_${modIndex}`, "1");
      }
    });

    // aplicar bloqueo inicial y arrancar control
    aplicarBloqueos();
    inicializarControlModulos();

    // finalmente, intentar sincronizar el estado de aprobaci√≥n comprobando la hoja de respuestas
    // Buscamos en la hoja de respuestas (si existe en hoja1 o hoja separada) por registros m√°s recientes.
    // Nota: para mantenerlo simple y sin permisos, asumimos la Hoja1 ya contiene las notas actualizadas.
  }

  /*************************************************************************
   * VENCIMIENTO helpers
   *************************************************************************/
  function calcularVencimiento(fechaInicio){
    if (!fechaInicio) return "";
    const [d,m,y] = fechaInicio.split("/");
    const fecha = new Date(`${y}-${m}-${d}`);
    fecha.setFullYear(fecha.getFullYear()+1);
    return fecha.toLocaleDateString("es-PE");
  }
  function estaVencido(fechaInicio){
    if (!fechaInicio) return true;
    const [d,m,y] = fechaInicio.split("/");
    const fecha = new Date(`${y}-${m}-${d}`);
    fecha.setFullYear(fecha.getFullYear()+1);
    return new Date() > fecha;
  }

  /*************************************************************************
   * BLOQUEO / DESBLOQUEO
   *************************************************************************/
  function aplicarBloqueos(){
    const modulos = document.querySelectorAll(".modulo");
    modulos.forEach((m, idx) => {
      if (idx === 0) { m.classList.remove("bloqueado"); return; }
      const anteriorOk = localStorage.getItem(`mod_ok_${idx-1}`) === "1";
      if (!anteriorOk) m.classList.add("bloqueado");
      else m.classList.remove("bloqueado");
    });
  }
  function desbloquearSiguiente(idx){
    const siguiente = document.getElementById(`modulo_${idx+1}`);
    if (siguiente) siguiente.classList.remove("bloqueado");
    aplicarBloqueos();
  }

  /*************************************************************************
   * CONTROL TEMPORIZADORES (Drive): persistente + contador + progreso
   *************************************************************************/
  function inicializarControlModulos(){
    document.querySelectorAll(".modulo").forEach((modulo, i) => {
      const frame = modulo.querySelector(".videoFrame");
      const mensaje = modulo.querySelector(".rotate-message");
      const form = document.getElementById(`form_${i}`);
      const contadorEl = document.getElementById(`contador_${i}`);
      const progressEl = document.getElementById(`progreso_${i}`);
      const refreshBtn = document.getElementById(`refresh_${i}`);
      const durSeg = parseInt(modulo.dataset.duracion, 10);

      // si ya completado -> estado final
      if (localStorage.getItem(`mod_ok_${i}`) === "1"){
        if (form) form.style.display = "none";
        contadorEl.textContent = "‚úî M√≥dulo completado";
        progressEl.style.width = "100%";
        modulo.classList.remove("bloqueado");
        desbloquearSiguiente(i);
        if (refreshBtn) refreshBtn.style.display = "none";
        return;
      }

      const startTs = parseInt(localStorage.getItem(`start_ts_${i}`) || "0", 10);
      const elapsedStored = parseInt(localStorage.getItem(`elapsed_${i}`) || "0", 10);

      function actualizarContadorSeg(segRestantes){
        if (segRestantes <= 0){
          contadorEl.textContent = "‚è≥ Tiempo completado - formulario habilitado";
          if (form) form.style.display = "block";
          localStorage.setItem(`mod_ok_${i}`, "1");
          desbloquearSiguiente(i);
          if (refreshBtn) refreshBtn.style.display = "none";
          progressEl.style.width = "100%";
          return;
        }
        const min = Math.floor(segRestantes/60);
        const sec = segRestantes % 60;
        contadorEl.textContent = `‚è±Ô∏è Tiempo restante: ${String(min).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
        const porcentaje = ((durSeg - segRestantes) / durSeg) * 100;
        progressEl.style.width = porcentaje + "%";
      }

      if (startTs && !isNaN(startTs)) {
        const now = Date.now();
        const already = Math.floor((now - startTs) / 1000) + elapsedStored;
        const rem = durSeg - already;
        if (rem <= 0) {
          localStorage.setItem(`mod_ok_${i}`, "1");
          contadorEl.textContent = "‚úî M√≥dulo completado";
          if (form) form.style.display = "block";
          progressEl.style.width = "100%";
          if (refreshBtn) refreshBtn.style.display = "none";
          desbloquearSiguiente(i);
          return;
        } else {
          let remaining = rem;
          actualizarContadorSeg(remaining);
          const intervalId = setInterval(() => {
            remaining--;
            const played = Math.max(0, durSeg - remaining);
            localStorage.setItem(`elapsed_${i}`, String(played));
            actualizarContadorSeg(remaining);
            if (remaining <= 0) clearInterval(intervalId);
          }, 1000);
        }
      } else {
        // mostrar tiempo total si no iniciado
        actualizarContadorSeg(durSeg);
      }

      // iniciar al click
      frame.addEventListener("click", () => {
        if (localStorage.getItem(`mod_ok_${i}`) === "1") return;
        if (i > 0 && localStorage.getItem(`mod_ok_${i-1}`) !== "1"){
          alert("Complete el m√≥dulo anterior antes de iniciar este.");
          return;
        }
        if (localStorage.getItem(`start_ts_${i}`)) {
          mensaje.classList.add("show");
          setTimeout(()=>mensaje.classList.remove("show"), 3000);
          return;
        }

        const now = Date.now();
        localStorage.setItem(`start_ts_${i}`, now.toString());
        localStorage.setItem(`elapsed_${i}`, "0");

        mensaje.classList.add("show");
        setTimeout(()=>mensaje.classList.remove("show"), 3000);

        let remaining;
        const startNow = parseInt(localStorage.getItem(`start_ts_${i}`), 10);
        const alreadySec = Math.floor((Date.now() - startNow)/1000) + parseInt(localStorage.getItem(`elapsed_${i}`) || "0",10);
        remaining = Math.max(0, durSeg - alreadySec);
        actualizarContadorSeg(remaining);

        const iv = setInterval(() => {
          if (localStorage.getItem(`mod_ok_${i}`) === "1") { clearInterval(iv); return; }
          remaining--;
          const played = Math.max(0, durSeg - remaining);
          localStorage.setItem(`elapsed_${i}`, String(played));
          actualizarContadorSeg(remaining);
          if (remaining <= 0) {
            clearInterval(iv);
            if (document.getElementById(`form_${i}`)) document.getElementById(`form_${i}`).style.display = "block";
            localStorage.setItem(`mod_ok_${i}`, "1");
            desbloquearSiguiente(i);
          }
        }, 1000);
      });

      frame.addEventListener("load", ()=>{
        try {
          frame.contentWindow?.addEventListener("fullscreenchange", ()=>{
            mensaje.classList.add("show");
            setTimeout(()=>mensaje.classList.remove("show"), 3000);
          });
        } catch(e){}
      });
    });
  }

  /*************************************************************************
   * refrescarModulo, logout
   *************************************************************************/
  async function refrescarModulo(btn){
    btn.disabled = true;
    btn.textContent = "Actualizando...";
    await cargarModulos();
    btn.textContent = "üîÑ Refrescar m√≥dulo";
    btn.disabled = false;
  }
  function logout(){
    sessionStorage.clear();
    window.location.href = "index.html";
  }

  /*************************************************************************
   * inicio
   *************************************************************************/
  aplicarLogo();
  cargarModulos();

  </script>
</body>
</html>
